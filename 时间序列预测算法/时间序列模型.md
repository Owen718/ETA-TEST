# 时间序列模型
author： JMU yetian/Owen
time： 2021/1/26
### 仅供内部传阅
## 常用时间序列模型

![1611658895133.png](img\1611658895133.png)

![1611658908376.png](img\1611658908376.png)

* AR：考虑历史数据对当前值$X_t$的影响。以前$P$期的序列值$x_{t-1},x_{t-2},..,x_{t-p}$为自变量。随机变量$x_t$的取值$X_t$为因变量建立线性回归模型。 式子中 $\phi_1$即$x_{t-1}$对$x_{t}$的影响程度大小系数，以此类推。
* MA： 不考虑历史数据对当前值的影响，而是考虑前q期的随机扰动对当前值的影响，即前q期随机扰动：
  $\epsilon_{t-1},\epsilon_{t-2},...,\epsilon_{t-q}$的线性回归模型。

* ARMA： 即AR、MA的叠加，不仅考虑历史数据的影响，也考虑历史数据的随机扰动的影响。即：ARMA的随机变量$X_t$的取值$x_t$不仅与以前$p$期的序列值有关，还与前$q$期的随机扰动有关。
  

**AR、MA、ARMA都针对的是平稳序列！**

而ARIMA模型，专门针对非平稳序列。
### ARIMA模型原理
* 全称：Autoregressive Integrated Moving Average Model
* 针对非平稳序列
* 注意到非平稳序列差分后会显示出平稳序列的性质，我们将非平稳序列做一次差分操作，称差分后的序列为**差分平稳序列**，对差分平稳序列可以使用针对平稳序列的模型进行拟合。
* ARIMA模型相比于ARMA模型其实就是多了一步差分的操作。
* 在将非平稳时间序列转化为平稳时间序列的过程中，将因变量仅对它的滞后值以及随机误差项的现值和滞后值进行回归所建立的模型
### ARIMA优缺点
* 优点：模型简单，只需要内生变量而不需要借助其他外生变量。
* 缺点：要求时序数据是稳定的，或者通过差分化之后是稳定的；本质上只能捕捉线性关系，不能捕捉非线性关系


#### 自相关函数与偏自相关函数
**自相关函数（ACF）是将有序的随机变量序列与其自身相比较，它反映了同一序列在不同时序的取值之间的相关性。**


**偏自相关函数（PACF）计算的是严格的两个变量之间的相关性，是剔除了中间变量的干扰之后所得到的两个变量之间的相关程度。**

对于一个平稳的$AR(p)$模型，求出滞后为$k$的自相关系数$p(k)$时，实际所得并不是$x(t)$与$x(t-k)$之间的相关关系。这是因为在这两个变量之间还存在$k-1$个变量，它们会对这个自相关系数产生一系列的影响，而这个$k-1$个变量本身又是与$x(t-k)$相关的。这对自相关系数$p(k)$的计算是一个不小的干扰。而偏自相关函数可以剔除这些干扰。

自相关函数和偏自相关函数可以通过SPSS、MATLAB等工具计算并画出图像，通过图像可以判断出对应的$p$与$q$应当如何取值。图像的纵坐标为相关系数，横坐标为阶数，可以看出阶数与相关系数之间是有一定的周期性关系的。而$p$与$q$的值便是最小的周期数。如果在之后的计算中发现$p$与$q$的取值无法通过模型检验，则再重新调整$p$与$q$的值，重新计算即可。



### 时序模型符号说明

* 常用按时间顺序排列的一组随机变量$$X_1,X_2,...,X_t$$来表示一个随机事件的时间序列，简记为${X_t}$,用$x_1,x_2,...,x_n$或${x_t,t=1,2,...,n}$表示该随机序列的$n$个有序观察值，称之为序列长度为$n$的观察值序列。
  
应用时间序列分析的目的就是给定一个已被观测了的时间序列，预测该序列的未来值。


### 时序模型
* 白噪声序列：值的分布是随机的，无规律可循，这样的序列是无价值的，不去研究。
* 平稳非白噪声序列：自变量随着因变量的变化在一定范围内波动。即观测值的方差是一个常数，是恒定的。
![1611660585718.png](img\1611660585718.png)
* 非平稳序列：
  图中红色部分即为非平稳序列，当把$x(t_n)-x(t_{n-1})$即可得到绿色图中的情况，即转化为了平稳非白噪声序列。
![1611661049552.png](img\1611661049552.png)

* 截尾和拖尾：
**拖尾指序列以指数率单调递减或震荡衰减，而截尾指序列从某个时点变得非常小：**


![1611664670176.png](img\1611664670176.png)


出现以下情况，通常视为(偏)自相关系数d阶截尾：
1）在最初的d阶明显大于2倍标准差范围
2）之后几乎95%的(偏)自相关系数都落在2倍标准差范围以内
3）且由非零自相关系数衰减为在零附近小值波动的过程非常突然

![1611665478227.png](img\1611665478227.png)


出现以下情况，通常视为(偏)自相关系数拖尾：
1）如果有超过5%的样本(偏)自相关系数都落入2倍标准差范围之外
2）或者是由显著非0的(偏)自相关系数衰减为小值波动的过程比较缓慢或非常连续。


![1611665468660.png](img\1611665468660.png)


![1611665523232.png](img\1611665523232.png)


**举例：**

![1611667683720.png](img\1611667683720.png)

![1611667690085.png](img\1611667690085.png)

（1）趋势序列 ACF 有 3 阶截尾，PACF 有 2 阶拖尾。因此可以选 p=2， q=3。
（2）残差序列 ACF 有 4 阶拖尾，PACF 有 4 阶截尾。因此可以选 p=4， q=4。

### AIC、BIC法则
通过拖尾和截尾对模型定阶，具有很强的主观性。回顾一下我们对于模型参数估计得方法，是通过对损失和正则项的加权评估。我们在参数选择的时候，需要平衡预测误差与模型复杂度。我们可以根据信息准则函数法，来确定模型的阶数。即AIC、BIC法则

AIC 准则全称是最小化信息量准则（Akaike Information Criterion）：

![1611667802049.png](img\1611667802049.png)

其中 L 表示模型的极大似然函数， K 表示模型参数个数。
AIC 准则存在一定的不足。当样本容量很大时，在 AIC 准则中拟合误差提供的信息就要受到样本容量的放大，而参数个数的惩罚因子却和样本容量没关系（一直是2），因此当样本容量很大时，使用 AIC 准则的模型不收敛于真实模型，它通常比真实模型所含的未知参数个数要多。


（Bayesian InformationCriterion）贝叶斯信息准则弥补了 AIC 的不足

![1611667852363.png](img\1611667852363.png)
其中 n 表示样本容量。显然，这两个评价指标越小越好。

**方法1 通过网格搜索，确定 AIC、BIC 最优的模型（p、q）
方法2 使用BIC矩阵，找到最小值对应的p和q即可**

![1611668267476.png](img\1611668267476.png)


**总结：首先看图，一种情况叫拖尾 tails off，拖着个长长的尾巴的拖尾，一种情况叫截尾 cuts off，尾巴被截断了的截尾。
口诀：
AR 脱截（ACF拖尾，PACF截尾）,MA截拖,ARMA拖拖
如果是前面两种情况，按照口诀你可以确定AR或者MA的pq，如果图是同时拖尾，或者同时截尾，直接用AIC BIC决定。**


**笔者总结：感觉还是算AIC BIC靠谱。也就是说先detrend，然后利用augmented DF test决定做几次差分，然后再看ACF和PACF，看看是不是MA或AR，如果都不是，那就用AIC，BIC定ARMA的阶**


![1611661273348.png](img\1611661273348.png)
**平稳序列的自相关图和偏相关图要么都是拖尾要么都是截尾。** 截尾就是在某阶之后，系数都为 0 ,怎么理解呢，看上面偏相关的图，当阶数为 1 的时候，系数值还是很大， 0.914. 二阶长的时候突然就变成了0.050,后面的值都很小，认为是趋于0,这种状况就是截尾。再就是拖尾，拖尾就是有一个衰减的趋势，但是不都为 0。图中的自相关图既不是拖尾也不是截尾。**以上的图的自相关是一个三角对称的形式，这种趋势是单调趋势的典型图形。即原序列为非平稳序列**

## 使用算法判断是否平稳、求$p,q$

* 单位根检验法：
`from statsmodels.tsa.stattools import adfuller as ADF`
`print('ADF检测结果为,ADF(data[x])')`
返回值依次为： adf,pvalue,usedleg,nobs,critrical value,icbest,regresults,resstore
第二项为**单位根值**
其中 pvalue值小于0.005的即为平稳序列，否则为非平稳序列。

## 关于白噪声序列校验

代码：
`from statsmodels.stats.diagnostic import acorr_ljungbox`
`print('白噪声结果为',accorr_ljunbox(D_data,lags=1)) #返回统计量和p值`
其中P值<0.05即不为白噪声，即通过校验。


平稳序列才能检验是否是白噪声。所以正确的步骤如下：

**1、检验平稳性，如果是平稳序列检验是否是白噪声；如果是不平稳序列则对原序列进行差分，差分后再检验平稳性。**
**2、如果平稳序列不是白噪声，则考虑对平稳序列进行建模（只是对均值建模考虑ARMA模型，加上前面的差分步骤称为ARIMA模型；如果考虑进一步对波动率建模，则对均值模型的残差进行建模，考虑GARCH模型或者推广的GARCH模型，如EGARCH等）**
**3、对序列建模后对模型残差进行白噪声检验，如果是白噪声则基本说明模型合理，如果不是则回头检查模型设定是否合理。**

**总结：白噪声通常放在平稳性校验后，白噪声校验通过说明数据才有分析价值！**

1.【对原始数据进行白噪声检验】首先看原始数据时序图，如果没有明显的长期趋势特征，则对原始数据进行平稳性检验，如果结果显著，说明数据是平稳的。但是这个时候并不能确定数据是不是具有分析的价值，所以对原始数据进行白噪声检验，如果结果显著，说明不是白噪声，则可以用ARMA，简单指数平滑法等进行分析。

2.【对差分后的数据进行白噪声检验】通过原始数据的时序图发现有明显的季节效应和长期趋势，或者根据平稳性检验发现数据不是平稳的，则需要对数据进行差分，通过差分以后的数据可能就平稳了，但是不确定它是不是具有分析价值，所以这个时候对差分以后的数据进行白噪声检验，通过检验以后，再用ARMA等模型。

3.【对残差序列进行白噪声检验】最后将数据特征提取完毕以后，也要对残差序列进行白噪声检验，如果结果不显著，说明是白噪声序列，残差中已经没有可以利用的信息了，从而结束信息的提取。


##### 判断是时序数据是稳定的方法（参考即可）
* 严谨的定义： 一个时间序列的随机变量是稳定的，当且仅当它的所有统计特征都是独立于时间的（是关于时间的常量）。
* 判断的方法：稳定的数据是没有趋势(trend)，没有周期性(seasonality)的; 即它的均值，在时间轴上拥有常量的振幅，并且它的方差，在时间轴上是趋于同一个稳定的值的。
* 可以使用Dickey-Fuller Test进行假设检验。（另起文章介绍）

### ARIMA 建模过程

![1611661579470.png](img\1611661579470.png)


### ARIMA 自回归移动平均模型说明
#### 自回归模型(AR model)
自回归模型是描述当前值与历史值之间的关系的模型，是一种用变量自身的历史事件数据对自身进行预测的方法。其公式如下：


![1611661653183.png](img\1611661653183.png)
**yt是当前值;μ是常数项;p是阶数;γi是自相关系数;ϵt是误差值。**
**自回归模型的使用有以下四项限制：**
* 该模型用自身的数据进行预测，即建模使用的数据与预测使用的数据是同一组数据；
* 使用的数据必须具有平稳性；
* 使用的数据必须有自相关性，如果自相关系数小于0.5，则不宜采用自回归模型；
* 自回归模型只适用于预测与自身前期相关的现象。

#### 移动平均模型(MA model)
移动平均模型关注的是自回归模型中的误差项的累加。它能够有效地消除预测中的随机波动。其公式如下：

![1611661905225.png](img\1611661905225.png)
其中各个字母的意义与AR公式相同，θi为MA公式的相关系数（即误差项的相关系数）。
#### 自回归移动平均模型(ARMA model)
将自回归模型与移动平均模型相结合，便可以得到移动平均模型。其公式如下:

![1611661966376.png](img\1611661966376.png)

**在这个公式中，$p$与$q$分别为自回归模型与移动平均模型的阶数，是需要人为定义的。$γ_i$与$θ_i$分别是两个模型的相关系数，是需要求解的。如果原始数据不满足平稳性要求而进行了差分，则为差分自相关移动平均模型（ARIMA），将差分后所得的新数据带入ARMA公式中即可。**

### ARIMA模型参数说明与求解
ARIMA模型有三个参数:p,d,q

* p--代表预测模型中采用的时序数据本身的滞后数(lags) ,也叫做AR/Auto-Regressive项
* d--代表时序数据需要进行几阶差分化，才是稳定的，也叫Integrated项。
* q--代表预测模型中采用的预测误差的滞后数(lags)，也叫做MA/Moving Average项








# 实际应用流程

![1611664345513.png](img\1611664345513.png)


# 参考链接
<https://blog.csdn.net/sunnyxidian/article/details/92946542?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161166120016780261926426%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161166120016780261926426&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-1-92946542.pc_search_result_cache&utm_term=ARIMA%E6%A8%A1%E5%9E%8B&spm=1018.2226.3001.4187>


<https://blog.csdn.net/Baby_bye/article/details/91561024?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161166120016780261926426%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161166120016780261926426&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-2-91561024.pc_search_result_cache&utm_term=ARIMA%E6%A8%A1%E5%9E%8B&spm=1018.2226.3001.4187>

<https://blog.csdn.net/HHXUN/article/details/79858672?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161166120016780261926426%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=161166120016780261926426&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-4-79858672.pc_search_result_cache&utm_term=ARIMA%E6%A8%A1%E5%9E%8B&spm=1018.2226.3001.4187>


<https://zhuanlan.zhihu.com/p/60648709>